var mapPart = new Array();
mapPart["10s17w"] = true;
mapPart["10s7e"] = true;
mapPart["11n11e"] = true;
mapPart["11n11w"] = true;
mapPart["11s11e"] = true;
mapPart["11s11w"] = true;
mapPart["11s17w"] = true;
mapPart["11s7e"] = true;
mapPart["12s10w"] = true;
mapPart["12s11w"] = true;
mapPart["12s12w"] = true;
mapPart["12s13w"] = true;
mapPart["12s14w"] = true;
mapPart["12s15w"] = true;
mapPart["12s16w"] = true;
mapPart["12s17w"] = true;
mapPart["12s7e"] = true;
mapPart["12s8w"] = true;
mapPart["12s9w"] = true;
mapPart["13n1e"] = true;
mapPart["13s6w"] = true;
mapPart["13s7e"] = true;
mapPart["13s7w"] = true;
mapPart["13s8w"] = true;
mapPart["14s1e"] = true;
mapPart["14s1w"] = true;
mapPart["14s2e"] = true;
mapPart["14s2w"] = true;
mapPart["14s3e"] = true;
mapPart["14s3w"] = true;
mapPart["14s4w"] = true;
mapPart["14s5w"] = true;
mapPart["14s6w"] = true;
mapPart["14s7e"] = true;
mapPart["14s7w"] = true;
mapPart["15s1e"] = true;
mapPart["15s1w"] = true;
mapPart["15s7e"] = true;
mapPart["16s1e"] = true;
mapPart["16s6e"] = true;
mapPart["16s7e"] = true;
mapPart["16s8e"] = true;
mapPart["17s1e"] = true;
mapPart["17s2e"] = true;
mapPart["17s3e"] = true;
mapPart["17s5e"] = true;
mapPart["17s6e"] = true;
mapPart["17s7e"] = true;
mapPart["17s8e"] = true;
mapPart["18s3e"] = true;
mapPart["18s4e"] = true;
mapPart["18s8e"] = true;
mapPart["19s4e"] = true;
mapPart["19s5e"] = true;
mapPart["19s6e"] = true;
mapPart["19s7e"] = true;
mapPart["19s8e"] = true;
mapPart["1n10e"] = true;
mapPart["1n10w"] = true;
mapPart["1n11e"] = true;
mapPart["1n11w"] = true;
mapPart["1n12e"] = true;
mapPart["1n12w"] = true;
mapPart["1n13e"] = true;
mapPart["1n13w"] = true;
mapPart["1n14e"] = true;
mapPart["1n14w"] = true;
mapPart["1n15e"] = true;
mapPart["1n15w"] = true;
mapPart["1n16e"] = true;
mapPart["1n16w"] = true;
mapPart["1n17e"] = true;
mapPart["1n17w"] = true;
mapPart["1n18e"] = true;
mapPart["1n18w"] = true;
mapPart["1n19e"] = true;
mapPart["1n19w"] = true;
mapPart["1n1e"] = true;
mapPart["1n1w"] = true;
mapPart["1n20e"] = true;
mapPart["1n20w"] = true;
mapPart["1n21e"] = true;
mapPart["1n21w"] = true;
mapPart["1n22e"] = true;
mapPart["1n22w"] = true;
mapPart["1n23e"] = true;
mapPart["1n23w"] = true;
mapPart["1n24e"] = true;
mapPart["1n24w"] = true;
mapPart["1n25e"] = true;
mapPart["1n25w"] = true;
mapPart["1n26e"] = true;
mapPart["1n26w"] = true;
mapPart["1n27e"] = true;
mapPart["1n27w"] = true;
mapPart["1n28e"] = true;
mapPart["1n28w"] = true;
mapPart["1n29e"] = true;
mapPart["1n29w"] = true;
mapPart["1n2e"] = true;
mapPart["1n2w"] = true;
mapPart["1n30e"] = true;
mapPart["1n30w"] = true;
mapPart["1n31e"] = true;
mapPart["1n31w"] = true;
mapPart["1n32e"] = true;
mapPart["1n32w"] = true;
mapPart["1n33e"] = true;
mapPart["1n33w"] = true;
mapPart["1n34e"] = true;
mapPart["1n35e"] = true;
mapPart["1n36e"] = true;
mapPart["1n37e"] = true;
mapPart["1n38e"] = true;
mapPart["1n39e"] = true;
mapPart["1n3e"] = true;
mapPart["1n3w"] = true;
mapPart["1n40e"] = true;
mapPart["1n41e"] = true;
mapPart["1n42e"] = true;
mapPart["1n43e"] = true;
mapPart["1n44e"] = true;
mapPart["1n45e"] = true;
mapPart["1n46e"] = true;
mapPart["1n47e"] = true;
mapPart["1n48e"] = true;
mapPart["1n4e"] = true;
mapPart["1n4w"] = true;
mapPart["1n5e"] = true;
mapPart["1n5w"] = true;
mapPart["1n6e"] = true;
mapPart["1n6w"] = true;
mapPart["1n7e"] = true;
mapPart["1n7w"] = true;
mapPart["1n8e"] = true;
mapPart["1n8w"] = true;
mapPart["1n9e"] = true;
mapPart["1n9w"] = true;
mapPart["1s17w"] = true;
mapPart["1s6w"] = true;
mapPart["1s7e"] = true;
mapPart["2n16e"] = true;
mapPart["2n17e"] = true;
mapPart["2n1w"] = true;
mapPart["2n22e"] = true;
mapPart["2n22w"] = true;
mapPart["2n23e"] = true;
mapPart["2n24e"] = true;
mapPart["2n25e"] = true;
mapPart["2n26e"] = true;
mapPart["2n27e"] = true;
mapPart["2n28e"] = true;
mapPart["2n29e"] = true;
mapPart["2n2w"] = true;
mapPart["2n30e"] = true;
mapPart["2n31e"] = true;
mapPart["2n32e"] = true;
mapPart["2n39e"] = true;
mapPart["2n3e"] = true;
mapPart["2n3w"] = true;
mapPart["2n4e"] = true;
mapPart["2n4w"] = true;
mapPart["2n5e"] = true;
mapPart["2n6e"] = true;
mapPart["2s17w"] = true;
mapPart["2s7e"] = true;
mapPart["2s9w"] = true;
mapPart["3n10e"] = true;
mapPart["3n18e"] = true;
mapPart["3n23e"] = true;
mapPart["3n24e"] = true;
mapPart["3n25e"] = true;
mapPart["3n26e"] = true;
mapPart["3n27e"] = true;
mapPart["3n28e"] = true;
mapPart["3n29e"] = true;
mapPart["3n2e"] = true;
mapPart["3n2w"] = true;
mapPart["3n30e"] = true;
mapPart["3n31e"] = true;
mapPart["3n3e"] = true;
mapPart["3n3w"] = true;
mapPart["3s17w"] = true;
mapPart["3s7e"] = true;
mapPart["4n24e"] = true;
mapPart["4n25e"] = true;
mapPart["4n26e"] = true;
mapPart["4n27e"] = true;
mapPart["4n28e"] = true;
mapPart["4n29e"] = true;
mapPart["4n2w"] = true;
mapPart["4n30e"] = true;
mapPart["4s17w"] = true;
mapPart["4s7e"] = true;
mapPart["5n12e"] = true;
mapPart["5n1w"] = true;
mapPart["5n25e"] = true;
mapPart["5n26e"] = true;
mapPart["5n27e"] = true;
mapPart["5n28e"] = true;
mapPart["5n29e"] = true;
mapPart["5n2w"] = true;
mapPart["5s17w"] = true;
mapPart["5s7e"] = true;
mapPart["6n1e"] = true;
mapPart["6n26e"] = true;
mapPart["6n27e"] = true;
mapPart["6n28e"] = true;
mapPart["6n2w"] = true;
mapPart["6n5w"] = true;
mapPart["6s17w"] = true;
mapPart["6s7e"] = true;
mapPart["7n27e"] = true;
mapPart["7n2w"] = true;
mapPart["7n7w"] = true;
mapPart["7s17w"] = true;
mapPart["7s7e"] = true;
mapPart["8n1w"] = true;
mapPart["8n2w"] = true;
mapPart["8n6e"] = true;
mapPart["8s17w"] = true;
mapPart["8s7e"] = true;
mapPart["9n2e"] = true;
mapPart["9s17w"] = true;

function eventPos(e) {
	if(e.type.match(/^touch/)) {
		e = e.originalEvent.changedTouches[0];
	}
	return {pageX: e.pageX, pageY: e.pageY};
}

var Map=function($container){
	$container.css({
		'z-index': 1,
		overflow: 'hidden',
		width: '740px',
		height: '694px',
		margin: '0px auto 0',
		background: '#fff',
		position: 'relative'
	});

	var $overlay = $container.children('img');
	$overlay.css({
		background: 'transparent',
		position: 'relative'
	});
	
	this.position = function() { return position };
	this.update = function() { update(); };
	this.info = function() { return {
		padding_top: padding_top,
		size: size,
		tilesize: tilesize,
		offset: offset,
		container_size: container_size,
		$map: $map,
		map_size: map_size
	}; };

	var sign=function(x){return x>0?+1:x<0?-1:0;};
	var pow=function(x,y){return Math.pow(Math.abs(x),y)*sign(x);}
	var clamp=function(x,min,max){return Math.max(Math.min(x,max),min);}

	var offset=$container.offset();

	var padding_top=200;
	var size=[14,48,25,33];
	var tilesize=2048;
	var visible=[];
	var container_size=[$container.width(),$container.height()];
	var scroll_delta=null;

	var $map=$container.children('.map');

	var map_size=[(size[1]+size[3])*tilesize,(size[0]+size[2])*tilesize];
	$map.css({
		width: map_size[0],
		height: map_size[1],
		position: 'absolute',
		zIndex: -1
	});

	var position=[-(size[3]+0.03)*tilesize,-(size[0]-0.55)*tilesize];

	$map.find('.ground').css({
		top: size[0]*tilesize,
		height: size[2]*tilesize,
		position: 'absolute',
		width: '100%',
		zIndex: -1,
		background: '#000'
	});

	var centre=[-1,0];

	var update=function(){
		$map.css({
			left:position[0],
			top:position[1]
		});

		var centre_last=centre;
		centre=[Math.floor(-position[0]/tilesize),Math.floor(-position[1]/tilesize)];

		tile_name=function(x,y){
			x-=size[3];
			y-=size[0];
			return (y>=0?(y+1)+'s':-y+'n')+(x>=0?(x+1)+'e':-x+'w');
		};

		if(centre[0]!=centre_last[0]||centre[1]!=centre_last[1]){
			var $remove=$map.children().not('.ground').not('#stickfigure');

			for(var y=-1;y<=+1;y++)
			for(var x=-1;x<=+1;x++){
				var name=tile_name(centre[0]+x,centre[1]+y);
				var tile=$map.find('.tile'+name);
				if(tile.length)
					$remove=$remove.not(tile);
				else if(mapPart[name] != undefined) {
					$image=$('<img data-name="' + name + '" class="tile'+name+'" src="imgs/'+name+'.png" style="top:'+((centre[1]+y)*tilesize)+'px;left:'+((centre[0]+x)*tilesize)+'px; z-index: -1; position: absolute;;" style="display:none" />');

					$image.load(function(){$(this).show()}).error(function(){$(this).remove();});
					$map.append($image);
					if($("#canvascontainer #" + name).length == 0) {
						var colImg = $(new Image());
						colImg.attr('src', 'imgs/'+name+'C.png')
						colImg.load(function(nm) { return function() {
							canvas = "<canvas id='"+nm+"' width='2048' height='2048'></canvas>";
							
							$("#canvascontainer").append(canvas);
							var context = document.getElementById(nm).getContext('2d');
							context.drawImage(this, 0, 0);
							collisionMap[nm] = context;
						}}(name)).error(function (nm) { return function() {
							if(!this.errorset) {
								$(this).attr('src', 'imgs/'+nm+'.png');
								this.errorset = true;
							}
							
						}}(name));
					}
					
					
				}
			}

			$remove.remove();
			
			activeMaps = $(".map img").not("#stickfigure").map(function (i, e) {
				var $this = $(this);

				return {
						left: 	$this.position().left,
						top: 	$this.position().top,
						width: 	$this.width(),
						height: $this.height(),
						src:	$this.attr('src'),
						id: 	$this.data('name'),
					}
			});
		}
	}

	update();

	function drag(e){
		if(scroll_delta){
			var pos = eventPos(e);
			position[0]=Math.round(clamp(pos.pageX+scroll_delta[0],-(size[1]+size[3])*tilesize+container_size[0],0));
			position[1]=Math.round(clamp(pos.pageY+scroll_delta[1],-(size[0]+size[2])*tilesize+container_size[1],0));
			update();
		}
	}

	/*$container
		.on('mousedown touchstart', function(e){
			if(e.button && e.button >= 2){
				return;
			}
			var pos = eventPos(e);
			scroll_delta=[position[0]-pos.pageX,position[1]-pos.pageY];
			$(document).on(e.type == 'mousedown' ? 'mousemove' : 'touchmove', drag);
			e.preventDefault();
		})
	;
	$(document)
		.on('mouseup touchend', function(e){
			$(document).off('mousemove touchmove', drag)
			scroll_delta=null;
		})
	;*/
};

/* 50:72:6f:50:75:6b:65:20:69:73:20:61:77:65:73:6f:6d:65 */
